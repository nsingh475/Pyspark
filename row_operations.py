## ------------------------------------------------  Example Dataset_1 ------------------------------------------------------------------------

#	+-------------------+----------+--------------------+
#	|id                 |    date  |           item_code|
#	+-------------------+----------+--------------------+
#	|                  1|2021-01-02|1                   |
#	|                  1|2021-01-02|4                   |
#	|                  1|2021-01-02|7                   |
#	|                  1|2021-01-03|2                   |
#	|                  3|2021-01-03|3                   |
#	|                  3|2021-01-03|1                   |
#	|                  2|2021-01-03|2                   |
#	|                  2|2021-01-03|6                   |
#	|                  2|2021-01-03|1                   |
#	|                  2|2021-01-04|3                   |
#	+-------------------+----------+--------------------+


## 1. Convert this to 

#	+-------------------+----------+--------------------+
#	|id                 |    date  | basket_of_item_code|
#	+-------------------+----------+--------------------+
#	|                  1|2021-01-02|[1, 4, 7]           |
#	|                  1|2021-01-03|[2]                 |
#	|                  2|2021-01-03|[2, 6, 1]           |
#	|                  2|2021-01-04|[3]                 |
#	|                  3|2021-01-03|[3, 1]              |
#	+-------------------+----------+--------------------+

baskets_df = df.groupBy ('id', 'date').agg (func.collect_set ("item_code").alias ('basket_of_item_code'))


## 2. Get all pairs of basket_of_items_code

#	+-------------------+----------+---------------------+
#	|id                 |    date  |   pairs_of_item_code|
#	+-------------------+----------+---------------------+
#	|                  1|2021-01-02|[1, 4], [1, 7], [4,7]|
#	|                  1|2021-01-03|[2]                  |
#	|                  2|2021-01-03|[2, 6], [2, 1], [6,1]|
#	|                  2|2021-01-04|[3]                  |
#	|                  3|2021-01-03|[3, 1]               |
#	+-------------------+----------+---------------------+


df_pairs = baskets_df.withColumn(
    "pairs_of_item_code", 
    expr("""
        filter(
            transform(
                flatten(
                    transform(
                        basket_of_item_code, 
                        x -> arrays_zip(
                            array_repeat(x, size(basket_of_item_code)), 
                            basket_of_item_code
                        )
                    )
                ), 
                x -> array(x['0'], x['basket_of_item_code'])
            ), 
            x -> x[0] < x[1]
        )
    """)
)



## ------------------------------------------------  Example Dataset_2 ------------------------------------------------------------------------

#	+---------+-----------+----------------+
#	|code_1   |code_2     |   probability  |
#	+---------+-----------+----------------+
#	|        1|         11|            0.01|
#	|        1|         12|            0.03|
#	|        1|         13|            0.04|
#	|        2|         21|            0.07|
#	|        2|         22|            0.09|
#	|        2|         23|            0.05|
#	+---------+----------+-----------------+ 


## 1. To get the following table

#	+---------+-----------+----------------+---------------+
#	|code_1   |code_2     |   probability  | code2_prob    |
#	+---------+-----------+----------------+---------------+
#	|        1|         11|            0.01|[11, 0.01]     |
#	|        1|         12|            0.03|[12, 0.03]     |
#	|        1|         13|            0.04|[13, 0.04]     |
#	|        2|         21|            0.07|[21, 0.07]     |
#	|        2|         22|            0.09|[22, 0.09]     |
#	|        2|         23|            0.05|[23, 0.05]     |
#	+---------+----------+-----------------+---------------+ 

df = df.withColumn('code2_prob', array([col('code_2'), col('probability')]))

## 2. To get the following table

#	+---------+-----------------------------------------+
#	|code_1   | list_code2_prob                         |
#	+---------+-----------------------------------------+
#	|        1|[[11 : 0.01], [12 : 0.03], [13 : 0.04]]  |
#	|        2|[[21 : 0.07], [22 : 0.09], [23 : 0.05]]  |
#	+---------+-----------------------------------------+ 

req_df = df.groupBy('code_1').agg (func.collect_list ("code2_prob").alias ('list_code2_prob'))


## 3. To get the following table

#	+---------+-----------------------------------------+
#	|code_1   | sorted_list_code2_prob                  |
#	+---------+-----------------------------------------+
#	|        1|[[13 : 0.04], [12 : 0.03], [11 : 0.01]]  |
#	|        2|[[22 : 0.09], [21 : 0.07], [23 : 0.05]]  |
#	+---------+-----------------------------------------+ 

df = req_df.rdd.map(lambda row: (row.code_1, sorted(row.list_code2_prob , reverse=True, key=lambda x:x[1]))).toDF (["code_1", "sorted_list_code2_prob "])


## 4. To get the following table

#	+---------+-----------+----------------+---------------+------------------+
#	|code_1   |code_2     |   probability  | code2_prob    | dict_code2_prob  |
#	+---------+-----------+----------------+---------------+------------------+
#	|        1|         11|            0.01|[11, 0.01]     |{11 : 0.01}       |
#	|        1|         12|            0.03|[12, 0.03]     |{12 : 0.03}       |
#	|        1|         13|            0.04|[13, 0.04]     |{13 : 0.04}       |
#	|        2|         21|            0.07|[21, 0.07]     |{21 : 0.07}       |
#	|        2|         22|            0.09|[22, 0.09]     |{22 : 0.09}       |
#	|        2|         23|            0.05|[23, 0.05]     |{23 : 0.05}       |
#	+---------+----------+-----------------+---------------+------------------+ 

from pyspark.sql.functions import udf
from pyspark.sql import types as T

@udf(T.MapType(T.StringType(), T.DoubleType()))
def create_struct(code_2, probability):
    return {code_2: probability}

final_df = df.withColumn('dict_code2_prob', create_struct(df.code_2, df.probability))


## 5. To get the following table

#	+---------+-----------------------------------------+
#	|code_1   | list_dict_code2_prob                    |
#	+---------+-----------------------------------------+
#	|        1|[{11 : 0.01}, {12 : 0.03}, {13 : 0.04}]  |
#	|        2|[{21 : 0.07}, {22 : 0.09}, {23 : 0.05}]  |
#	+---------+-----------------------------------------+ 

req_df = final_df.groupBy('code_1').agg (func.collect_list ("dict_code2_prob").alias ('list_dict_code2_prob'))



